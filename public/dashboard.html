// =========================
// HELPERS
// =========================
function el(id) {
  return document.getElementById(id);
}

function safeJSONParse(value) {
  try {
    return JSON.parse(value);
  } catch {
    return null;
  }
}

function formatDateISO(date) {
  return date.toISOString().split('T')[0];
}

function formatHour(dateStr) {
  return new Date(dateStr).toLocaleTimeString('pt-BR', {
    hour: '2-digit',
    minute: '2-digit'
  });
}

// =========================
// STORAGE
// =========================
const token = localStorage.getItem('token');
const user = safeJSONParse(localStorage.getItem('user'));

console.log('üì¶ Token:', !!token);
console.log('üë§ User:', user);

// =========================
// üîí PROTE√á√ÉO DA P√ÅGINA
// =========================
function protegerPagina() {
  if (!token || !user) {
    window.location.replace('/');
    return false;
  }

  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    const agora = Math.floor(Date.now() / 1000);

    if (payload.exp < agora) {
      logout();
      return false;
    }
  } catch {
    logout();
    return false;
  }

  return true;
}

function logout() {
  localStorage.clear();
  window.location.replace('/');
}

if (!protegerPagina()) {
  throw new Error('P√°gina protegida');
}

// =========================
// HEADER ‚Äî CRECHE + TURMA
// =========================
if (el('nomeCreche')) {
  el('nomeCreche').textContent =
    user?.creche?.nome || 'Ambiente Tia Bia';
}

if (el('nomeTurma')) {
  el('nomeTurma').textContent =
    user?.turma?.nome || 'Maternal';
}

const logoutBtn = el('logoutBtn');
if (logoutBtn) {
  logoutBtn.addEventListener('click', logout);
}

// =========================
// CONTROLE POR PERFIL
// =========================
console.log('üé≠ Perfil:', user.perfil);

if (user.perfil === 'ADMIN') {
  el('admin').hidden = false;
  carregarDashboardAdmin();
}

if (user.perfil === 'EDUCADOR') {
  el('educador').hidden = false;
}

if (user.perfil === 'RESPONSAVEL') {
  el('responsavel').hidden = false;
}

// =========================
// DASHBOARD ADMIN (mock)
// =========================
async function carregarDashboardAdmin() {
  el('totalUsuarios').textContent = '12';
  el('totalCriancas').textContent = '5';
  el('totalEventos').textContent = '48';
}

// =========================
// AGENDA ‚Äî API
// =========================
async function carregarAgendaPorData(date) {
  const dataISO = formatDateISO(date);

  console.log('üì° Buscando agenda:', dataISO);

  try {
    const res = await fetch(`/api/eventos?data=${dataISO}`, {
      headers: {
        Authorization: `Bearer ${token}`
      }
    });

    if (!res.ok) {
      throw new Error('Erro ao buscar eventos');
    }

    const eventos = await res.json();
    renderAgenda(eventos);

  } catch (err) {
    console.error('‚ùå Erro agenda:', err);
  }
}

// =========================
// RENDER AGENDA (MANH√É / TARDE)
// =========================
function renderAgenda(eventos) {
  const agendaContainer =
    el('agendaEducador') || el('agendaResponsavel');

  if (!agendaContainer) return;

  agendaContainer.innerHTML = '';

  if (!eventos.length) {
    agendaContainer.innerHTML =
      '<p>üì≠ Nenhum evento para este dia</p>';
    return;
  }

  const manha = [];
  const tarde = [];

  eventos.forEach(e => {
    const hora = new Date(e.hora).getHours();
    hora < 12 ? manha.push(e) : tarde.push(e);
  });

  if (manha.length) {
    agendaContainer.appendChild(
      criarPeriodo('Manh√£', manha)
    );
  }

  if (tarde.length) {
    agendaContainer.appendChild(
      criarPeriodo('Tarde', tarde)
    );
  }
}

function criarPeriodo(titulo, eventos) {
  const bloco = document.createElement('div');

  const h3 = document.createElement('h3');
  h3.textContent = titulo;
  bloco.appendChild(h3);

  eventos.forEach(e => {
    bloco.appendChild(criarEventoCard(e));
  });

  return bloco;
}

function criarEventoCard(evento) {
  const article = document.createElement('article');
  article.className = `event ${evento.tipo}`;

  article.innerHTML = `
    <h4>${tituloEvento(evento.tipo)}</h4>
    <span>${formatHour(evento.hora)}</span>
    <p>${evento.descricao}</p>
  `;

  return article;
}

function tituloEvento(tipo) {
  const map = {
    food: 'Alimenta√ß√£o',
    sleep: 'Soneca',
    play: 'Brincadeiras',
    hygiene: 'Higiene',
    learn: 'Aprendizado'
  };

  return map[tipo] || 'Atividade';
}

// =========================
// INTEGRA√á√ÉO COM CALEND√ÅRIO
// =========================
document.addEventListener('calendar:dateSelected', (e) => {
  const date = e.detail.date;
  carregarAgendaPorData(date);
});

// =========================
// INIT (hoje)
// =========================
carregarAgendaPorData(new Date());
